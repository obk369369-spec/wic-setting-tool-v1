<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WIC 세팅 도구 v2 — 카드형 세팅 & 안정화 버전</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      line-height: 1.5;
      background: #f5f5f5;
      font-size: 14px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .section {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 13px;
      margin-bottom: 6px;
      resize: vertical;
    }
    textarea#toolList {
      min-height: 80px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .row > div {
      flex: 1 1 200px;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #888;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: #2563eb;
      color: #ffffff;
      border-color: #2563eb;
    }
    button.small {
      padding: 4px 8px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #ccc;
      margin-right: 4px;
      margin-bottom: 2px;
      cursor: pointer;
    }
    .badge.selected {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .status-ok {
      color: #15803d;
      font-weight: 600;
    }
    .status-warn {
      color: #b91c1c;
      font-weight: 600;
    }
    .status-neutral {
      color: #4b5563;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 160px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    .card-title {
      font-weight: 700;
      font-size: 14px;
    }
    .card-chip {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid #ccc;
      color: #4b5563;
    }
    .card-desc {
      font-size: 12px;
      color: #4b5563;
    }
    .card-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .card-row input[type="text"] {
      flex: 1;
      margin-bottom: 0;
    }
    .log {
      font-size: 11px;
      color: #4b5563;
      background: #f9fafb;
      border-radius: 6px;
      padding: 4px 6px;
      min-height: 32px;
      white-space: pre-wrap;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }
    .autosave {
      font-size: 11px;
      color: #4b5563;
    }
    .pill {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #111827;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h1>WIC 세팅 도구 v2 (7번 도구)</h1>
  <div class="section">
    <div class="small-text">
      · 이 도구는 <strong>카드형 세팅 도구</strong>다.<br/>
      · 테스트 규칙: <strong>화면 출력 1회 → 기능 1회 반복 → 오류 0이면 종료</strong> 한 번만 수행한다.<br/>
      · 브라우저 <strong>localStorage 자동 저장/복원</strong>만 사용하며, 서버 통신·백그라운드 타이머는 사용하지 않는다.
    </div>
  </div>

  <div class="section">
    <h2>① 도구 목록 & 기본 주소</h2>
    <label for="toolList">도구 목록 (한 줄당 1개, 예: "1번 고객 자동화 안내서")</label>
    <textarea id="toolList" placeholder="1번 고객 자동화 안내서&#10;2번 입찰 프로그램&#10;3번 코딩 기초 연습 뼈대&#10;..."></textarea>

    <div class="row">
      <div>
        <label for="githubBase">GitHub 기본 주소</label>
        <input id="githubBase" type="text" placeholder="예: https://github.com/obk369369-spec" />
      </div>
      <div>
        <label for="denoBase">Deno 기본 주소</label>
        <input id="denoBase" type="text" placeholder="예: https://dash.deno.com/projects" />
      </div>
    </div>

    <div class="row" style="margin-top:4px;">
      <button id="buildCardsBtn" class="primary">카드 생성 / 갱신</button>
      <button id="runAllTestsBtn">전체 자동 테스트 1회</button>
      <button id="clearStateBtn">데이터 초기화</button>
      <div class="autosave" id="autosaveStatus">자동 저장 상태: 대기 중</div>
    </div>
  </div>

  <div class="section">
    <h2>② 자동 테스트 규칙</h2>
    <div class="small-text">
      · 테스트는 네트워크 요청 없이 <strong>문자열 규칙</strong>만으로 판단한다.<br/>
      · GitHub/Deno 주소가 비어 있거나, 공백만 있거나, "http"로 시작하지 않으면 <span class="status-warn">오류 가능</span>으로 표시된다.<br/>
      · 두 주소 모두 "http"로 시작하면 <span class="status-ok">정상</span>으로 표시되고, 로그에 1회 테스트 결과만 기록한다.
    </div>
  </div>

  <div class="section">
    <h2>③ 도구 카드 (자동 생성 영역)</h2>
    <div id="cardsContainer" class="cards-grid">
      <!-- JS가 카드 자동 생성 -->
    </div>
    <div class="small-text" style="margin-top:6px;">
      · 도구 목록을 수정한 뒤 <strong>카드 생성 / 갱신</strong>을 누르면 카드 구성이 즉시 다시 만들어진다.<br/>
      · 각 카드의 입력·로그·오류 선택지는 브라우저에 자동 저장되어, 새로고침 후에도 복원된다.
    </div>
  </div>

  <script>
    // ===== 상태 구조 =====
    const STORAGE_KEY = "wic_setup_tool_v2_state";

    let state = {
      toolListText: "",
      githubBase: "",
      denoBase: "",
      cards: [] // { name, github, deno, status, log, lastTest, errorChoice }
    };

    function nowTime() {
      return new Date().toLocaleTimeString("ko-KR", { hour12: false });
    }

    // ===== 상태 저장/복원 =====
    function saveState() {
      try {
        state.toolListText = document.getElementById("toolList").value;
        state.githubBase = document.getElementById("githubBase").value;
        state.denoBase = document.getElementById("denoBase").value;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        const el = document.getElementById("autosaveStatus");
        el.textContent = "자동 저장 상태: " + nowTime() + " 자동 저장 완료";
      } catch (e) {
        const el = document.getElementById("autosaveStatus");
        el.textContent = "자동 저장 상태: 저장 실패(" + e.message + ")";
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return;
        state = Object.assign(state, obj);
        document.getElementById("toolList").value = state.toolListText || "";
        document.getElementById("githubBase").value = state.githubBase || "";
        document.getElementById("denoBase").value = state.denoBase || "";
      } catch (e) {
        // 복원 실패는 조용히 무시
      }
    }

    // ===== 유틸 =====
    function normalizeName(line) {
      return line.trim();
    }

    function findCardState(name) {
      return state.cards.find(c => c.name === name);
    }

    function ensureCardState(name) {
      let card = findCardState(name);
      if (!card) {
        card = {
          name,
          github: "",
          deno: "",
          status: "대기",
          log: "",
          lastTest: "",
          errorChoice: ""
        };
        state.cards.push(card);
      }
      return card;
    }

    function validateAddresses(github, deno) {
      const g = (github || "").trim();
      const d = (deno || "").trim();
      if (!g && !d) {
        return { ok: false, reason: "GitHub/Deno 주소가 비어 있음" };
      }
      if (!g || !d) {
        return { ok: false, reason: "GitHub 또는 Deno 중 하나만 입력됨" };
      }
      if (!g.startsWith("http") || !d.startsWith("http")) {
        return { ok: false, reason: "두 주소 모두 http로 시작해야 함" };
      }
      return { ok: true, reason: "형식상 정상" };
    }

    // ===== 카드 생성/갱신 =====
    function buildCardsFromList() {
      const listText = document.getElementById("toolList").value || "";
      const lines = listText.split("\n")
        .map(l => normalizeName(l))
        .filter(l => l.length > 0);

      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      const usedNames = [];

      lines.forEach((line, idx) => {
        const name = line;
        usedNames.push(name);
        const cardState = ensureCardState(name);

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.name = name;

        // 상단
        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = name;

        const chip = document.createElement("div");
        chip.className = "card-chip";
        chip.textContent = (idx + 1) + "번 도구";

        header.appendChild(title);
        header.appendChild(chip);
        card.appendChild(header);

        // 설명 (이름 그대로 한 줄)
        const desc = document.createElement("div");
        desc.className = "card-desc";
        desc.textContent = "기능 요약: " + name + " (필요 시 나중에 교체 가능)";
        card.appendChild(desc);

        // GitHub 입력
        const ghRow = document.createElement("div");
        ghRow.className = "card-row";
        const ghInput = document.createElement("input");
        ghInput.type = "text";
        ghInput.placeholder = state.githubBase
          ? state.githubBase + "/..."
          : "이 도구 GitHub 주소";
        ghInput.value = cardState.github || "";
        const ghBtn = document.createElement("button");
        ghBtn.className = "small";
        ghBtn.textContent = "GitHub 열기";
        ghBtn.onclick = () => {
          const url = ghInput.value.trim();
          if (url.startsWith("http")) window.open(url, "_blank");
        };
        ghRow.appendChild(ghInput);
        ghRow.appendChild(ghBtn);
        card.appendChild(ghRow);

        // Deno 입력
        const deRow = document.createElement("div");
        deRow.className = "card-row";
        const deInput = document.createElement("input");
        deInput.type = "text";
        deInput.placeholder = state.denoBase
          ? state.denoBase + "/..."
          : "이 도구 Deno 주소";
        deInput.value = cardState.deno || "";
        const deBtn = document.createElement("button");
        deBtn.className = "small";
        deBtn.textContent = "Deno 열기";
        deBtn.onclick = () => {
          const url = deInput.value.trim();
          if (url.startsWith("http")) window.open(url, "_blank");
        };
        deRow.appendChild(deInput);
        deRow.appendChild(deBtn);
        card.appendChild(deRow);

        // 상태 라인
        const statusLine = document.createElement("div");
        const statusSpan = document.createElement("span");
        statusSpan.className = "status-neutral";
        const statusLabel = cardState.status || "대기";
        if (statusLabel === "정상") statusSpan.className = "status-ok";
        else if (statusLabel === "오류 가능") statusSpan.className = "status-warn";
        statusSpan.textContent = "상태: " + statusLabel;
        const timeSpan = document.createElement("span");
        timeSpan.className = "small-text";
        timeSpan.style.marginLeft = "6px";
        timeSpan.textContent = cardState.lastTest
          ? "(마지막 테스트: " + cardState.lastTest + ")"
          : "(테스트 전)";
        statusLine.appendChild(statusSpan);
        statusLine.appendChild(timeSpan);
        card.appendChild(statusLine);

        // 오류 선택지
        const errorArea = document.createElement("div");
        errorArea.className = "small-text";
        errorArea.textContent = "오류 시 선택지:";
        const choices = [
          "GitHub 재배포",
          "Deno 재배포",
          "코어 기능 재구성"
        ];
        choices.forEach(choice => {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = choice;
          if (cardState.errorChoice === choice) {
            badge.classList.add("selected");
          }
          badge.onclick = () => {
            cardState.errorChoice = choice;
            // 선택 상태 갱신
            Array.from(errorArea.querySelectorAll(".badge")).forEach(b => {
              b.classList.toggle("selected", b.textContent === choice);
            });
            saveState();
          };
          errorArea.appendChild(badge);
        });
        card.appendChild(errorArea);

        // 버튼들
        const btnRow = document.createElement("div");
        btnRow.className = "card-row";
        const saveBtn = document.createElement("button");
        saveBtn.className = "small";
        saveBtn.textContent = "주소 저장";
        saveBtn.onclick = () => {
          cardState.github = ghInput.value.trim();
          cardState.deno = deInput.value.trim();
          saveState();
        };
        const testBtn = document.createElement("button");
        testBtn.className = "small primary";
        testBtn.textContent = "테스트";
        testBtn.onclick = () => {
          runSingleTest(name, ghInput.value, deInput.value, statusSpan, timeSpan, logArea);
        };
        btnRow.appendChild(saveBtn);
        btnRow.appendChild(testBtn);
        card.appendChild(btnRow);

        // 로그
        const logArea = document.createElement("div");
        logArea.className = "log";
        logArea.textContent = cardState.log || "로그: 아직 없음";
        card.appendChild(logArea);

        container.appendChild(card);
      });

      // state.cards에서 사용되지 않는 항목은 그대로 두되, 저장은 새 카드 기준으로 진행
      state.cards = state.cards.filter(c => usedNames.includes(c.name));
      saveState();
    }

    // ===== 테스트 실행 =====
    function runSingleTest(name, ghValue, deValue, statusSpan, timeSpan, logArea) {
      const cardState = ensureCardState(name);
      const res = validateAddresses(ghValue, deValue);
      const t = nowTime();
      cardState.github = ghValue.trim();
      cardState.deno = deValue.trim();
      cardState.lastTest = t;

      if (res.ok) {
        cardState.status = "정상";
        statusSpan.className = "status-ok";
      } else {
        cardState.status = "오류 가능";
        statusSpan.className = "status-warn";
      }
      statusSpan.textContent = "상태: " + cardState.status;
      timeSpan.textContent = "(마지막 테스트: " + t + ")";
      cardState.log = "테스트 시간: " + t + " · 결과: " + res.reason;
      logArea.textContent = cardState.log;
      saveState();
    }

    function runAllTestsOnce() {
      const container = document.getElementById("cardsContainer");
      const cards = Array.from(container.querySelectorAll(".card"));
      cards.forEach(card => {
        const name = card.dataset.name;
        const ghInput = card.querySelector(".card-row input[type='text']");
        const inputs = card.querySelectorAll(".card-row input[type='text']");
        const gh = inputs[0] ? inputs[0].value : "";
        const de = inputs[1] ? inputs[1].value : "";
        const statusSpan = card.querySelector(".status-ok, .status-warn, .status-neutral");
        const timeSpan = card.querySelector(".small-text");
        const logArea = card.querySelector(".log");
        if (name && statusSpan && timeSpan && logArea) {
          runSingleTest(name, gh, de, statusSpan, timeSpan, logArea);
        }
      });
    }

    function clearState() {
      if (!confirm("저장된 세팅 도구 상태를 모두 지울까요?")) return;
      state = {
        toolListText: "",
        githubBase: "",
        denoBase: "",
        cards: []
      };
      document.getElementById("toolList").value = "";
      document.getElementById("githubBase").value = "";
      document.getElementById("denoBase").value = "";
      document.getElementById("cardsContainer").innerHTML = "";
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById("autosaveStatus").textContent = "자동 저장 상태: 초기화 완료";
    }

    // ===== 이벤트 바인딩 =====
    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      buildCardsFromList();

      document.getElementById("buildCardsBtn").onclick = () => {
        buildCardsFromList();
      };
      document.getElementById("runAllTestsBtn").onclick = () => {
        runAllTestsOnce();
      };
      document.getElementById("clearStateBtn").onclick = () => {
        clearState();
      };

      // 입력 변경 시 자동 저장 (숨은 타이머 없이 input 이벤트에만 반응)
      ["toolList", "githubBase", "denoBase"].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener("input", () => {
          saveState();
        });
      });
    });
  </script>
</body>
</html>
