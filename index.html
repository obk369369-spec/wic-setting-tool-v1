<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WIC 세팅 도구 v2 — 카드형 세팅 & 안정화 버전 (목록 보존 + 번호 정렬)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      line-height: 1.5;
      background: #f5f5f5;
      font-size: 14px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .section {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 13px;
      margin-bottom: 6px;
      resize: vertical;
    }
    textarea#toolList {
      min-height: 80px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .row > div {
      flex: 1 1 200px;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #888;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: #2563eb;
      color: #ffffff;
      border-color: #2563eb;
    }
    button.small {
      padding: 4px 8px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #ccc;
      margin-right: 4px;
      margin-bottom: 2px;
      cursor: pointer;
    }
    .badge.selected {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .status-ok {
      color: #15803d;
      font-weight: 600;
    }
    .status-warn {
      color: #b91c1c;
      font-weight: 600;
    }
    .status-neutral {
      color: #4b5563;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 160px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    .card-title {
      font-weight: 700;
      font-size: 14px;
    }
    .card-chip {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid #ccc;
      color: #4b5563;
    }
    .card-desc {
      font-size: 12px;
      color: #4b5563;
    }
    .card-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .card-row input[type="text"] {
      flex: 1;
      margin-bottom: 0;
    }
    .log {
      font-size: 11px;
      color: #4b5563;
      background: #f9fafb;
      border-radius: 6px;
      padding: 4px 6px;
      min-height: 32px;
      white-space: pre-wrap;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }
    .autosave {
      font-size: 11px;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <h1>WIC 세팅 도구 v2 (7번 도구)</h1>
  <div class="section">
    <div class="small-text">
      · 이 도구는 <strong>카드형 세팅 도구</strong>다.<br/>
      · 테스트 규칙: <strong>화면 출력 1회 → 기능 1회 반복 → 오류 0이면 종료</strong> 한 번만 수행한다.<br/>
      · 브라우저 <strong>localStorage 자동 저장/복원</strong>만 사용하며, 서버 통신·백그라운드 타이머는 사용하지 않는다.
    </div>
  </div>

  <div class="section">
    <h2>① 도구 목록 & 기본 주소</h2>
    <label for="toolList">도구 목록 (한 줄당 1개)</label>
    <textarea id="toolList" placeholder="1번 고객 자동화 안내서&#10;2번 입찰 프로그램&#10;3번 코딩 기초 연습 뼈대"></textarea>

    <div class="row">
      <div>
        <label for="githubBase">GitHub 기본 주소</label>
        <input id="githubBase" type="text" placeholder="https://github.com/사용자명" />
      </div>
      <div>
        <label for="denoBase">Deno 기본 주소</label>
        <input id="denoBase" type="text" placeholder="https://dash.deno.com/projects" />
      </div>
    </div>

    <div class="row">
      <button id="buildCardsBtn" class="primary">카드 생성 / 갱신</button>
      <button id="runAllTestsBtn">전체 자동 테스트 1회</button>
      <button id="clearStateBtn">데이터 초기화</button>
      <div id="autosaveStatus" class="autosave">자동 저장 상태: 대기 중</div>
    </div>
  </div>

  <div class="section">
    <h2>② 자동 테스트 규칙</h2>
    <div class="small-text">
      · 테스트는 네트워크 요청 없이 문자열 규칙만으로 판단한다.<br/>
      · GitHub/Deno 주소가 비어 있거나 http로 시작하지 않으면 오류 가능.<br/>
      · 두 주소 모두 http로 시작하면 정상으로 표시되고 로그를 남긴다.
    </div>
  </div>

  <div class="section">
    <h2>③ 도구 카드 (자동 생성 영역)</h2>
    <div id="cardsContainer" class="cards-grid"></div>
  </div>

  <script>
    const STORAGE_KEY = "wic_setup_tool_v2_state";

    let state = {
      toolListText: "",
      githubBase: "",
      denoBase: "",
      cards: [] // { name, github, deno, status, log, last, choice }
    };

    function now() {
      return new Date().toLocaleTimeString("ko-KR", { hour12: false });
    }

    // ----- 저장 / 복원 -----
    function saveState() {
      state.toolListText = document.getElementById("toolList").value;
      state.githubBase = document.getElementById("githubBase").value;
      state.denoBase = document.getElementById("denoBase").value;
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        document.getElementById("autosaveStatus").textContent =
          "자동 저장: " + now();
      } catch (e) {
        document.getElementById("autosaveStatus").textContent =
          "자동 저장 오류: " + e.message;
      }
    }

    let saveTimer = null;
    function scheduleSaveState() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveState();
        saveTimer = null;
      }, 500); // 0.5초 지연 저장
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        if (obj && typeof obj === "object") {
          state = Object.assign(state, obj);
          document.getElementById("toolList").value = state.toolListText || "";
          document.getElementById("githubBase").value = state.githubBase || "";
          document.getElementById("denoBase").value = state.denoBase || "";
        }
      } catch (_) {
        // 무시
      }
    }

    // ----- 카드 상태 -----
    function ensureCard(name) {
      let card = state.cards.find(c => c.name === name);
      if (!card) {
        card = {
          name,
          github: "",
          deno: "",
          status: "대기",
          log: "",
          last: "",
          choice: ""
        };
        state.cards.push(card);
      }
      return card;
    }

    function validate(g, d) {
      g = (g || "").trim();
      d = (d || "").trim();
      if (!g && !d) return { ok: false, reason: "GitHub/Deno 주소가 비어 있음" };
      if (!g || !d) return { ok: false, reason: "한쪽 주소만 입력됨" };
      if (!g.startsWith("http") || !d.startsWith("http"))
        return { ok: false, reason: "주소가 http로 시작해야 함" };
      return { ok: true, reason: "정상" };
    }

    // ----- 도구 목록 → 정렬 → 카드 생성 -----
    function buildCards() {
      const raw = document.getElementById("toolList").value || "";
      const lines = raw
        .split("\n")
        .map(x => x.trim())
        .filter(x => x.length > 0);

      // 번호 추출 + 자동 정렬
      const items = lines.map((line, idx) => {
        const m = line.match(/^(\d+)\s*번?/); // "18번", "18 번" 둘 다 인식
        const num = m ? parseInt(m[1], 10) : 10000 + idx; // 번호 없으면 뒤로
        return { name: line, num, idx };
      });

      items.sort((a, b) => {
        if (a.num === b.num) return a.idx - b.idx;
        return a.num - b.num;
      });

      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      const usedNames = [];

      items.forEach((item, sortedIndex) => {
        const name = item.name;
        usedNames.push(name);
        const c = ensureCard(name);

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.name = name;

        // 헤더
        const header = document.createElement("div");
        header.className = "card-header";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = name;
        const chip = document.createElement("div");
        chip.className = "card-chip";
        chip.textContent = (sortedIndex + 1) + "번 카드"; // 실제 순서
        header.appendChild(title);
        header.appendChild(chip);
        card.appendChild(header);

        // 설명
        const desc = document.createElement("div");
        desc.className = "card-desc";
        desc.textContent = "기능 요약: " + name;
        card.appendChild(desc);

        // GitHub 입력
        const ghRow = document.createElement("div");
        ghRow.className = "card-row";
        const ghInput = document.createElement("input");
        ghInput.type = "text";
        ghInput.placeholder = state.githubBase
          ? state.githubBase + "/…"
          : "이 도구 GitHub 주소";
        ghInput.value = c.github || "";
        const ghBtn = document.createElement("button");
        ghBtn.className = "small";
        ghBtn.textContent = "GitHub 열기";
        ghBtn.onclick = () => {
          const url = ghInput.value.trim();
          if (url.startsWith("http")) window.open(url, "_blank");
        };
        ghRow.appendChild(ghInput);
        ghRow.appendChild(ghBtn);
        card.appendChild(ghRow);

        // Deno 입력
        const deRow = document.createElement("div");
        deRow.className = "card-row";
        const deInput = document.createElement("input");
        deInput.type = "text";
        deInput.placeholder = state.denoBase
          ? state.denoBase + "/…"
          : "이 도구 Deno 주소";
        deInput.value = c.deno || "";
        const deBtn = document.createElement("button");
        deBtn.className = "small";
        deBtn.textContent = "Deno 열기";
        deBtn.onclick = () => {
          const url = deInput.value.trim();
          if (url.startsWith("http")) window.open(url, "_blank");
        };
        deRow.appendChild(deInput);
        deRow.appendChild(deBtn);
        card.appendChild(deRow);

        // 상태 표시
        const statusLine = document.createElement("div");
        const stSpan = document.createElement("span");
        const statusLabel = c.status || "대기";
        if (statusLabel === "정상") stSpan.className = "status-ok";
        else if (statusLabel === "오류 가능") stSpan.className = "status-warn";
        else stSpan.className = "status-neutral";
        stSpan.textContent = "상태: " + statusLabel;

        const timeSpan = document.createElement("span");
        timeSpan.className = "small-text";
        timeSpan.style.marginLeft = "6px";
        timeSpan.textContent = c.last
          ? "(마지막 테스트: " + c.last + ")"
          : "(테스트 전)";

        statusLine.appendChild(stSpan);
        statusLine.appendChild(timeSpan);
        card.appendChild(statusLine);

        // 오류 선택지
        const errArea = document.createElement("div");
        errArea.className = "small-text";
        errArea.textContent = "오류 시 선택지:";
        ["GitHub 재배포", "Deno 재배포", "코어 기능 재구성"].forEach(choice => {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = choice;
          if (c.choice === choice) badge.classList.add("selected");
          badge.onclick = () => {
            c.choice = choice;
            Array.from(errArea.querySelectorAll(".badge")).forEach(b =>
              b.classList.toggle("selected", b.textContent === choice)
            );
            saveState();
          };
          errArea.appendChild(badge);
        });
        card.appendChild(errArea);

        // 버튼들 (주소 저장 + 테스트)
        const btnRow = document.createElement("div");
        btnRow.className = "card-row";

        const saveBtn = document.createElement("button");
        saveBtn.className = "small";
        saveBtn.textContent = "주소 저장";
        saveBtn.onclick = () => {
          c.github = ghInput.value.trim();
          c.deno = deInput.value.trim();
          saveState();
        };

        const testBtn = document.createElement("button");
        testBtn.className = "small primary";
        testBtn.textContent = "테스트";
        testBtn.onclick = () => {
          runSingleTest(name, ghInput, deInput, stSpan, timeSpan, logArea);
        };

        btnRow.appendChild(saveBtn);
        btnRow.appendChild(testBtn);
        card.appendChild(btnRow);

        // 로그
        const logArea = document.createElement("div");
        logArea.className = "log";
        logArea.textContent = c.log || "로그: 아직 없음";
        card.appendChild(logArea);

        container.appendChild(card);
      });

      // 사용하지 않는 카드 정리
      state.cards = state.cards.filter(c => usedNames.includes(c.name));
      saveState();
    }

    // ----- 테스트 -----
    function runSingleTest(name, ghInput, deInput, statusSpan, timeSpan, logArea) {
      const c = ensureCard(name);
      const g = ghInput.value;
      const d = deInput.value;
      const r = validate(g, d);

      c.github = (g || "").trim();
      c.deno = (d || "").trim();
      c.last = now();
      c.log = "테스트: " + c.last + " / 결과: " + r.reason;

      if (r.ok) {
        c.status = "정상";
        statusSpan.className = "status-ok";
      } else {
        c.status = "오류 가능";
        statusSpan.className = "status-warn";
      }
      statusSpan.textContent = "상태: " + c.status;
      timeSpan.textContent = "(마지막 테스트: " + c.last + ")";
      logArea.textContent = c.log;

      saveState();
    }

    function testAll() {
      const cards = document.querySelectorAll(".card");
      cards.forEach(card => {
        const name = card.dataset.name;
        const inputs = card.querySelectorAll("input[type='text']");
        if (inputs.length < 2) return;
        const ghInput = inputs[0];
        const deInput = inputs[1];
        const statusSpan = card.querySelector(
          ".status-ok, .status-warn, .status-neutral"
        );
        const timeSpan = card.querySelector(".small-text");
        const logArea = card.querySelector(".log");
        runSingleTest(name, ghInput, deInput, statusSpan, timeSpan, logArea);
      });
    }

    function clearAll() {
      if (!confirm("모든 저장 데이터를 초기화할까요?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = {
        toolListText: "",
        githubBase: "",
        denoBase: "",
        cards: []
      };
      document.getElementById("toolList").value = "";
      document.getElementById("githubBase").value = "";
      document.getElementById("denoBase").value = "";
      document.getElementById("cardsContainer").innerHTML = "";
      document.getElementById("autosaveStatus").textContent = "초기화 완료";
    }

    // ----- 초기화 -----
    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      buildCards();

      document.getElementById("buildCardsBtn").onclick = () => {
        buildCards();
      };
      document.getElementById("runAllTestsBtn").onclick = () => {
        testAll();
      };
      document.getElementById("clearStateBtn").onclick = () => {
        clearAll();
      };

      // 입력시 0.5초 지연 자동 저장
      ["toolList", "githubBase", "denoBase"].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener("input", scheduleSaveState);
      });

      window.addEventListener("beforeunload", () => {
        if (saveTimer) {
          clearTimeout(saveTimer);
          saveState();
        }
      });
    });
  </script>
</body>
</html>
