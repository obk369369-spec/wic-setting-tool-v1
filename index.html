<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>7번 세팅 도구 · Setup & Monitor Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 16px 24px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.8;
    }
    main {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 16px 18px;
      margin-bottom: 16px;
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 24px;
      font-size: 13px;
      color: #4b5563;
    }
    .meta-label {
      font-weight: 600;
      color: #111827;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
      margin-right: 4px;
    }
    .pill.ok {
      background: #dcfce7;
      color: #166534;
    }
    .pill.warn {
      background: #fef9c3;
      color: #854d0e;
    }
    .pill.err {
      background: #fee2e2;
      color: #b91c1c;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 0;
    }
    button {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      background: #ffffff;
      font-size: 13px;
      cursor: pointer;
    }
    button.primary {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th:nth-child(2), td:nth-child(2) {
      white-space: normal;
    }
    tr:hover td {
      background: #f9fafb;
    }
    .status-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-block;
    }
    .status-정상 {
      background: #dcfce7;
      color: #166534;
    }
    .status-경고 {
      background: #fef9c3;
      color: #854d0e;
    }
    .status-오류 {
      background: #fee2e2;
      color: #b91c1c;
    }
    .status-미연결 {
      background: #e5e7eb;
      color: #4b5563;
    }
    .link {
      color: #2563eb;
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .badge-small {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
      margin-left: 4px;
    }
    .error-box {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 12px;
    }
    @media (max-width: 640px) {
      header, main {
        padding-left: 12px;
        padding-right: 12px;
      }
      .meta-row {
        flex-direction: column;
        gap: 4px;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>7번 세팅 도구 · Setup &amp; Monitor Center</h1>
    <p>각 도구의 플랫폼 세팅 · 자동 테스트 · 자동 수정 상태를 한 화면에서 관리하는 전용 도구입니다.</p>
  </header>

  <main>
    <!-- 엔진 상태 카드 -->
    <section class="card" id="engine-card">
      <h2>엔진 상태 · 요약</h2>
      <div class="meta-row">
        <div><span class="meta-label">엔진 상태:</span> <span id="engine-status">대기</span></div>
        <div><span class="meta-label">마지막 갱신:</span> <span id="last-updated">--:--</span></div>
        <div><span class="meta-label">도구 개수:</span> <span id="tool-count">0</span></div>
      </div>
      <div class="meta-row" style="margin-top: 6px;">
        <div>
          <span class="meta-label">도구 상태 요약:</span>
          <span class="pill ok" id="summary-ok">정상 0</span>
          <span class="pill warn" id="summary-warn">경고 0</span>
          <span class="pill err" id="summary-err">오류 0</span>
        </div>
        <div>
          <span class="meta-label">복잡 오류 개수:</span>
          <span id="complex-error-count">0</span>
        </div>
      </div>
      <div class="toolbar">
        <button class="primary" id="btn-refresh">도구 목록 새로 불러오기</button>
        <button id="btn-run-all">전체 자동 테스트 실행 (예시)</button>
      </div>
      <p class="help-text">
        · 도구 목록은 <code>/api/tools.json</code>에서 자동으로 감지합니다.  
        · 불러온 목록은 브라우저 저장소(localStorage)에 보관되어, 창을 꺼도 다시 나타납니다.
      </p>
      <div id="engine-error" class="error-box" style="display:none;"></div>
    </section>

    <!-- 도구별 세팅 및 상태 -->
    <section class="card">
      <h2>도구별 세팅 및 상태</h2>
      <p class="help-text">
        · 이 버전부터는 도구를 “클릭해서 열기만 해도” 현재 진행중인 도구 목록을 자동으로 감지해 보여주는 구조를 목표로 합니다.  
        · 지금은 <code>/api/tools.json</code>에서 목록을 받아오는 형태이며, 나중에 플랫폼의 자동 감지 API로 교체할 수 있습니다.
      </p>

      <div class="toolbar">
        <input id="search-input" type="text" placeholder="도구 이름 또는 번호 검색" style="flex:1; min-width:160px; padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; font-size:13px;" />
        <button id="btn-clear">검색 지우기</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>도구 이름</th>
              <th>상태</th>
              <th>코드 저장소 주소</th>
              <th>배포 주소</th>
              <th>마지막 테스트</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="tool-table-body">
            <!-- 여기에 JS가 자동으로 행을 채웁니다. -->
          </tbody>
        </table>
      </div>

      <p class="help-text">
        · 각 행의 “자동 테스트 실행 / 자동 테스트 오류 보기” 버튼은 다음 단계에서 실제 API와 연결할 수 있도록 자리만 잡아둔 상태입니다.  
        · 지금은 눌러보면 “아직 연결 전(예시)” 안내만 표시됩니다.
      </p>
    </section>

    <!-- 도구별 자동 테스트·자동 수정 요약(자리만) -->
    <section class="card">
      <h2>도구별 자동 테스트·자동 수정 요약</h2>
      <p class="help-text">
        여기에는 “자동으로 고칠 수 있는 오류”와 “사용자 선택이 필요한 오류”가 모여서 표시됩니다.  
        지금은 예시 카드만 두고, 실제 데이터 연결은 다음 단계에서 추가할 수 있습니다.
      </p>
      <div id="auto-fix-summary">
        <p class="help-text">현재 자동 수집된 오류 정보 없음 (예시 단계).</p>
      </div>
    </section>
  </main>

  <script>
    // ===== 설정값 =====
    // 플랫폼이 제공할 도구 목록 API 주소.
    const TOOLS_API_URL = "/api/tools.json";
    const STORAGE_KEY = "wic_tool_list_v1";

    // 상태 집계용
    let tools = [];

    function formatTime(date) {
      const d = date instanceof Date ? date : new Date(date);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    function statusClass(status) {
      if (status === "정상") return "status-정상";
      if (status === "경고") return "status-경고";
      if (status === "오류") return "status-오류";
      if (status === "미연결") return "status-미연결";
      return "status-미연결";
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch (e) {
        console.warn("localStorage load error:", e);
        return null;
      }
    }

    function saveToStorage(list) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      } catch (e) {
        console.warn("localStorage save error:", e);
      }
    }

    function updateSummary() {
      const count = tools.length;
      document.getElementById("tool-count").textContent = count.toString();

      let ok = 0, warn = 0, err = 0;
      let complex = 0;

      tools.forEach(t => {
        const status = t.status || "미연결";
        if (status === "정상") ok++;
        else if (status === "경고") warn++;
        else if (status === "오류") err++;

        if (t.complexError === true) complex++;
      });

      document.getElementById("summary-ok").textContent = `정상 ${ok}`;
      document.getElementById("summary-warn").textContent = `경고 ${warn}`;
      document.getElementById("summary-err").textContent = `오류 ${err}`;
      document.getElementById("complex-error-count").textContent = complex.toString();
    }

    function renderTable(filterText = "") {
      const tbody = document.getElementById("tool-table-body");
      tbody.innerHTML = "";

      const lower = filterText.trim().toLowerCase();
      const filtered = tools.filter(t => {
        if (!lower) return true;
        const key = `${t.id ?? ""} ${t.name ?? ""}`.toLowerCase();
        return key.includes(lower);
      });

      filtered.forEach(t => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = t.id ?? "-";
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.textContent = t.name ?? "-";
        tr.appendChild(tdName);

        const tdStatus = document.createElement("td");
        const s = t.status || "미연결";
        const span = document.createElement("span");
        span.textContent = s;
        span.className = "status-badge " + statusClass(s);
        tdStatus.appendChild(span);
        tr.appendChild(tdStatus);

        const tdRepo = document.createElement("td");
        if (t.repoUrl) {
          const a = document.createElement("a");
          a.href = t.repoUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "열기";
          a.className = "link";
          tdRepo.appendChild(a);
        } else {
          tdRepo.textContent = "-";
        }
        tr.appendChild(tdRepo);

        const tdDeploy = document.createElement("td");
        if (t.deployUrl) {
          const a = document.createElement("a");
          a.href = t.deployUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "열기";
          a.className = "link";
          tdDeploy.appendChild(a);
        } else {
          tdDeploy.textContent = "-";
        }
        tr.appendChild(tdDeploy);

        const tdLast = document.createElement("td");
        tdLast.textContent = t.lastTest || "-";
        tr.appendChild(tdLast);

        const tdActions = document.createElement("td");
        const btnRun = document.createElement("button");
        btnRun.textContent = "자동 테스트 실행";
        btnRun.onclick = () => {
          alert(`(예시) [${t.id ?? "-"}번 ${t.name ?? ""}] 자동 테스트 실행 API와 연결 예정입니다.`);
        };
        const btnError = document.createElement("button");
        btnError.textContent = "자동 테스트 오류 보기";
        btnError.style.marginLeft = "4px";
        btnError.onclick = () => {
          alert(`(예시) [${t.id ?? "-"}번 ${t.name ?? ""}] 오류 상세 보기 화면은 다음 단계에서 추가합니다.`);
        };
        tdActions.appendChild(btnRun);
        tdActions.appendChild(btnError);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    async function fetchToolsFromApi() {
      const errorBox = document.getElementById("engine-error");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      document.getElementById("engine-status").textContent = "목록 불러오는 중…";

      try {
        const res = await fetch(TOOLS_API_URL, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        if (!Array.isArray(data)) {
          throw new Error("API 응답 형식이 배열이 아닙니다.");
        }

        // 기대 형식:
        // [
        //   {
        //     "id": 1,
        //     "name": "1번 고객 자동화 안내서",
        //     "status": "미연결" | "정상" | "경고" | "오류",
        //     "repoUrl": "https://github.com/.../tool-1",
        //     "deployUrl": "https://1-guide...deno.net/",
        //     "lastTest": "-",
        //     "complexError": false
        //   },
        //   ...
        // ]
        tools = data;
        saveToStorage(tools);

        document.getElementById("engine-status").textContent = "정상";
        document.getElementById("last-updated").textContent = formatTime(new Date());
        updateSummary();
        renderTable(document.getElementById("search-input").value);

      } catch (err) {
        console.error("도구 목록 불러오기 오류:", err);

        const stored = loadFromStorage();
        if (stored) {
          tools = stored;
          document.getElementById("engine-status").textContent = "저장된 목록 사용 중";
          document.getElementById("last-updated").textContent = "저장본";
          updateSummary();
          renderTable(document.getElementById("search-input").value);
        } else {
          document.getElementById("engine-status").textContent = "오류";
          errorBox.style.display = "block";
          errorBox.textContent = "도구 목록을 불러오지 못했습니다. /api/tools.json을 확인하거나 나중에 다시 열어 주세요.";
        }
      }
    }

    function initEvents() {
      document.getElementById("btn-refresh").onclick = () => {
        fetchToolsFromApi();
      };
      document.getElementById("btn-run-all").onclick = () => {
        alert("(예시) 전체 자동 테스트 실행 API와 연결 예정입니다.");
      };
      const searchInput = document.getElementById("search-input");
      searchInput.addEventListener("input", () => {
        renderTable(searchInput.value);
      });
      document.getElementById("btn-clear").onclick = () => {
        searchInput.value = "";
        renderTable("");
      };
    }

    // 초기 실행
    (function bootstrap() {
      initEvents();

      const stored = loadFromStorage();
      if (stored) {
        tools = stored;
        document.getElementById("engine-status").textContent = "저장된 목록 사용 중";
        document.getElementById("last-updated").textContent = "저장본";
        updateSummary();
        renderTable("");
      } else {
        document.getElementById("engine-status").textContent = "대기";
      }

      // 페이지를 열면 자동으로 한 번 목록을 시도해서 가져온다.
      fetchToolsFromApi();
    })();
  </script>
</body>
</html>
